<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ event[2] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="title-bar">
        <div><strong><a class="signin-link" href="/">OrganizeYourMeet</a></strong></div>
        <div class="avatar">
            <a class="signin-link" href="/login">â˜»</a>
        </div>
    </div>

    <div class="navbar">
        <div class="navbar-left">
            <a href="/new-event">New Event</a>
            <a href="/your-events">Your Events</a>
        </div>
        <a href="/calendar">{{ username }}</a>
    </div>

    <h2 style="margin-left: 20px;">{{ event[2] }}</h2>
    <p style="margin-left: 20px;">{{ event[3] }}</p>

    <div class="calendar-container">
        <table class="calendar-table" id="calendar">
            <!-- Generated by JS -->
        </table>
    </div>

    <script>
        const startDate = new Date("{{ start_date }}");
        const event = {{ event|tojson|safe }};
        const numDays = (new Date(event[6]) - new Date(event[5])) / (1000 * 60 * 60 * 24)+1;
        const timeSlotsPerDay = {{ event[8] }};
        const participantsBlocks = {{ participants_blocks|tojson|safe }};

        function pad(n) {
            return n.toString().padStart(2, '0');
        }

        function formatTime(slot) {
            const hours = Math.floor(slot / 4) + Number.parseInt(event[7].split(':')[0]);
            const minutes = (slot % 4) * 15 + Number.parseInt(event[7].split(':')[1]);
            return `${pad(hours)}:${pad(minutes)}`;
        }

        function markAvailabilityBlocks() {
            const cells = document.querySelectorAll('.slot');
            cells.forEach(cell => {
                const day = parseInt(cell.dataset.day);
                const slot = parseInt(cell.dataset.slot) + Number.parseInt(event[7].split(':')[0]) * 4 + Number.parseInt(event[7].split(':')[1]) / 15;
                const date = new Date(startDate);
                date.setDate(date.getDate() + day);
                const dateStr = date.toISOString().split('T')[0];
                let intervals = Object.keys(participantsBlocks).length;

                let overlaps = 0;
                for (const [username, blocks] of Object.entries(participantsBlocks)) {
                    console.log(`Checking availability for ${username}`);
                    console.log(dateStr, slot);
                    console.log(blocks);
                    const hasBlock = blocks.some(block => 
                        block.date === dateStr && block.time_slot === slot
                    );
                    if (hasBlock) overlaps++;
                }

                if (overlaps > 0) {
                    cell.classList.add(`overlap-${Math.min(Math.ceil(overlaps/intervals*5), 5)}`);
                }
            });
        }
        function markExistingBlocks() {
            if (!availabilityBlocks) return;
            
            availabilityBlocks.forEach(block => {
                const blockDate = new Date(block.date);
                const dayDiff = Math.floor((blockDate - startDate) / (1000 * 60 * 60 * 24));
                const slot = block.time_slot;
                
                const cell = document.querySelector(`.slot[data-day="${dayDiff}"][data-slot="${slot}"]`);
                if (cell) {
                cell.classList.add('selected');
                }
            });
        }

        function generateCalendar() {
            const table = document.getElementById('calendar');
            const headerRow = document.createElement('tr');
            headerRow.appendChild(document.createElement('th')); // top-left empty cell

            for (let d = 0; d < numDays; d++) {
                const day = new Date(startDate);
                day.setDate(day.getDate() + d);
                const th = document.createElement('th');
                th.textContent = `${day.getDate()}/${day.getMonth() + 1}`;
                headerRow.appendChild(th);
            }

            table.appendChild(headerRow);

            for (let slot = 0; slot < timeSlotsPerDay; slot++) {
                const row = document.createElement('tr');
                const timeCell = document.createElement('td');
                timeCell.className = 'time-col';
                timeCell.textContent = formatTime(slot);
                row.appendChild(timeCell);

                for (let d = 0; d < numDays; d++) {
                const cell = document.createElement('td');
                cell.className = 'slot';
                cell.classList.add('available'); 
                cell.dataset.day = d;
                cell.dataset.slot = slot;
                
                // cell.addEventListener('mousedown', (e) => {
                //     isSelecting = true;
                //     startCell = cell;
                //     lastCell = cell;
                //     isAddingSelection = !cell.classList.contains('selected');
                //     cell.classList.toggle('selected');
                //     e.preventDefault(); 
                // });

                // cell.addEventListener('mouseover', () => {
                //     if (isSelecting) {
                //     selectCellsBetween(startCell, cell);
                //     lastCell = cell;
                //     }
                // });

                row.appendChild(cell);
                }

                table.appendChild(row);
        
            }
            // markExistingBlocks();
        }
        generateCalendar();
        markAvailabilityBlocks();
    </script>
</body>
</html>